.PHONY: deploy build-local

# ë°°í¬ ëŒ€ìƒ ì„œë²„ ëª©ë¡
DEPLOY_SERVERS ?= ktb-fe01
DEPLOY_PATH ?= /home/ubuntu/ktb-chat-frontend

# ë¡œì»¬ì—ì„œ í”„ë¡œë•ì…˜ ë¹Œë“œ
build-local:
	@echo "ğŸ—ï¸  Building locally..."
	npm run build:production
	@echo "âœ… Local build completed!"

deploy:
	@echo "ğŸ“¦ Deploying to remote servers..."
	@for server in $(DEPLOY_SERVERS); do \
		echo "â†’ Deploying to $$server..."; \
		ssh $$server "mkdir -p $(DEPLOY_PATH)"; \
		echo "  ğŸ“ Copying standalone build..."; \
		rsync -avz --delete --exclude='*.log' --exclude='.env*' --exclude="server.pid" --exclude='/package.json' .next/standalone/ $$server:$(DEPLOY_PATH)/; \
		echo "  ğŸ“ Copying static files..."; \
		rsync -avz --delete .next/static $$server:$(DEPLOY_PATH)/.next/; \
		echo "  ğŸ“ Copying public files..."; \
		rsync -avz --delete public $$server:$(DEPLOY_PATH)/; \
		echo "  ğŸ“ Copying restart script..."; \
		rsync -avz restart.sh $$server:$(DEPLOY_PATH)/; \
		echo "  ğŸ”„ Restarting server..."; \
		ssh $$server "cd $(DEPLOY_PATH) && chmod +x restart.sh && ./restart.sh"; \
		echo "âœ… Deployment to $$server completed!"; \
	done
	@echo "âœ… All deployments completed!"


DOCKER_USER ?= michael568
IMAGE_NAME = ktb-chat-frontend
TAG ?= latest
# ì‹¤ì œ ë°°í¬í•  ë°±ì—”ë“œ ì£¼ì†Œ
PROD_API_URL ?= https://chat.goorm-ktb-019.goorm.team
PROD_SOCKET_URL ?= https://chat.goorm-ktb-019.goorm.team

docker-build:
	docker build \
		--platform linux/amd64 \
		--build-arg NEXT_PUBLIC_API_URL=$(PROD_API_URL) \
		--build-arg NEXT_PUBLIC_SOCKET_URL=$(PROD_SOCKET_URL) \
		-t $(DOCKER_USER)/$(IMAGE_NAME):$(TAG) .

docker-push:
	docker push $(DOCKER_USER)/$(IMAGE_NAME):$(TAG)

# í•œ ë²ˆì— ì‹¤í–‰: make docker-deploy
docker-deploy: docker-build docker-push
	@echo "ì´ë¯¸ì§€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ. EC2ì—ì„œ 'docker pull ...' í›„ ì‹¤í–‰í•˜ì„¸ìš”."