###################################
# Environment Variables
###################################
# ArtilleryÍ∞Ä Î∂ÄÌïòÎ•º Ï£ºÎäî ÎåÄÏÉÅ URL
export BASE_URL ?= https://chat.goorm-ktb-019.goorm.team

# ÎåÄÎüâ Ï±ÑÌåÖÎ∞úÏÜ° Ïãú, Î∞úÏÜ°ÎêòÎäî Î©îÏãúÏßÄ Í∞ØÏàò
export MASS_MESSAGE_COUNT ?= 10

# Í∞Å Scenario Ï§ëÍ∞ÑÏùò ActionÏóê ÎåÄÌïú Timeout ÏÑ§Ï†ï (Î∞ÄÎ¶¨Ï¥à Îã®ÏúÑ)
export ACTION_TIMEOUT ?= 1000
export ACTION_TIMEOUT_SHORT ?= 500
export ACTION_TIMEOUT_LONG ?= 2000

# Í∏àÏπôÏñ¥ Î™©Î°ù (ÏâºÌëúÎ°ú Íµ¨Î∂Ñ)
export FORBIDDEN_WORDS ?= "b3sig78jv,9c0hej6x,lbl276sz"

# ArtilleryÏóêÏÑú Î∂ÄÌïòÌÖåÏä§Ìä∏ ÏÑ§Ï†ï
export PHASE1_DURATION ?= 60 # Ìï¥Îãπ ÏãúÍ∞Ñ ÎÇ¥Ïóê
export PHASE1_ARRIVAL_COUNT ?= 1 # Î™áÎ™ÖÏùò Í∞ÄÏÉÅ Ïú†Ï†ÄÎ•º ÏÉùÏÑ±Ìï†Í±¥ÏßÄ?

verify-env:
	# Check Node.js installed
	@command -v node 2>&1 || { echo >&2 "‚ùå Node.js is not installed. Please install Node.js to proceed."; exit 1; }

	# Check npx installed
	@command -v npx 2>&1 || { echo >&2 "‚ùå npx is not installed. Please install Node.js (which includes npx) to proceed."; exit 1; }

	# Check Artillery Package Installed
	@npm list artillery 2>&1 || { echo >&2 "‚ùå Artillery is not installed . Installing Artillery..."; npm install artillery; }

export REPORT_JSON := results/$(shell date +'%Y%m%d%H%M%S')-report.json
export REPORT_HTML := results/$(shell date +'%Y%m%d%H%M%S')-report.html

artillery:
	@mkdir -p results
	@echo "üöÄ Running basic head test ($(PHASE1_ARRIVAL_COUNT) users for $(PHASE1_DURATION)s)..."
	@npx artillery run --output $(REPORT_JSON) artillery-config.yaml
	@echo "‚úÖ Load test finished. Generating HTML report..."
	@npx artillery report $(REPORT_JSON) -o $(REPORT_HTML)
	@echo "‚ú® Report saved to $(REPORT_HTML)"